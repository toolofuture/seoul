import json
import csv
import sys
import os

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ëœì°¨ì´ì¦ˆ ì—…ì¢… ë¶„ì„ (ê³µì •ê±°ë˜ìœ„ì›íšŒ ê³µê³µë°ì´í„° 2024)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 40px; }
        h2 { border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 50px; color: #34495e; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 30px; }
        .advice-box { background-color: #e8f6f3; border-left: 5px solid #1abc9c; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .advice-title { font-weight: bold; color: #16a085; margin-bottom: 10px; font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .rank-badge { background-color: #e74c3c; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; }
        footer { margin-top: 50px; text-align: center; color: #7f8c8d; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>í”„ëœì°¨ì´ì¦ˆ ì—…ì¢… ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <p style="text-align: center;">2024ë…„ ì •ë³´ê³µê°œì„œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œìš¸ ì†Œìƒê³µì¸ì„ ìœ„í•œ íŠ¸ë Œë“œ ë¶„ì„</p>

        <div class="advice-box">
            <div class="advice-title">ğŸ’¡ ì„œìš¸ ì†Œìƒê³µì¸ì„ ìœ„í•œ í•µì‹¬ ì¡°ì–¸</div>
            <ul>
                <li><strong>ì„±ì¥ì„¸ ì£¼ëª©:</strong> ì‹ ê·œ ê°œì  ìˆ˜ê°€ ë§ì€ ë¸Œëœë“œëŠ” ì‹œì¥ì˜ ìˆ˜ìš”ê°€ ë†’ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íŠ¹íˆ ë°°ë‹¬ ë° ì†Œìë³¸ ì°½ì—… ì•„ì´í…œì´ ê°•ì„¸ì…ë‹ˆë‹¤.</li>
                <li><strong>íì ë¥  ì²´í¬:</strong> ê¸‰ì„±ì¥í•˜ëŠ” ë¸Œëœë“œ ì¤‘ ì¼ë¶€ëŠ” íì  ìˆ˜ë„ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆœì¦ê°€(ì‹ ê·œ-íì ) ì§€í‘œë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.</li>
                <li><strong>ë§¤ì¶œì•¡ ë¶„ì„:</strong> ë‹¨ìˆœ ë§¤ì¶œì•¡ë³´ë‹¤ëŠ” ë§¤ì¥ ë©´ì ë‹¹ ë§¤ì¶œì•¡ì´ë‚˜ ì´ˆê¸° íˆ¬ìë¹„ìš© ëŒ€ë¹„ ìˆ˜ìµì„±ì„ ë”°ì ¸ë´ì•¼ í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <h2>ğŸ”¥ ëœ¨ëŠ” ë¸Œëœë“œ (ì‹ ê·œ ê°œì  Top 5)</h2>
        <div class="chart-container">
            <canvas id="growthChart"></canvas>
        </div>
        
        <h2>ğŸ’° ê³ ìˆ˜ìµ ë¸Œëœë“œ (í‰ê·  ë§¤ì¶œ Top 5)</h2>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>

        <h2>ğŸ“‰ íì  ì£¼ì˜ ë¸Œëœë“œ (íì  ìˆ˜ ìƒìœ„)</h2>
        <div class="chart-container">
            <canvas id="closeChart"></canvas>
        </div>

        <h2>ğŸ† ì¢…í•© ìˆœìœ„ (ì„±ì¥ ìˆœì¦ê°€ Top 10)</h2>
        <table>
            <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>ë¸Œëœë“œëª…</th>
                    <th>ì‹ ê·œê°œì </th>
                    <th>ìˆœì¦ê°€</th>
                    <th>ì „ì²´ì í¬</th>
                    <th>í‰ê· ë§¤ì¶œ(ì²œì›)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <footer>
            <p>Data Source: ê³µì •ê±°ë˜ìœ„ì›íšŒ ê°€ë§¹ì‚¬ì—…ê±°ë˜ ì •ë³´ê³µê°œì„œ (2024)</p>
            <p>Generated by AI Assistant</p>
        </footer>
    </div>

    <script>
        const growthData = __GROWTH_DATA__;
        const salesData = __SALES_DATA__;
        const closeData = __CLOSE_DATA__;
        const tableData = __TABLE_DATA__;

        new Chart(document.getElementById('growthChart'), {
            type: 'bar',
            data: {
                labels: growthData.map(d => d.brand),
                datasets: [{
                    label: 'ì‹ ê·œ ê°œì  ìˆ˜',
                    data: growthData.map(d => d.new_open),
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        new Chart(document.getElementById('salesChart'), {
            type: 'bar',
            data: {
                labels: salesData.map(d => d.brand),
                datasets: [{
                    label: 'í‰ê·  ë§¤ì¶œì•¡ (ì²œì›)',
                    data: salesData.map(d => d.avg_sales),
                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        new Chart(document.getElementById('closeChart'), {
            type: 'bar',
            data: {
                labels: closeData.map(d => d.brand),
                datasets: [{
                    label: 'ê³„ì•½ ì¢…ë£Œ+í•´ì§€ ìˆ˜',
                    data: closeData.map(d => d.close_count),
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const tableBody = document.getElementById('tableBody');
        tableData.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="rank-badge">${index + 1}</span></td>
                <td>${row.brand}</td>
                <td>${row.new_open.toLocaleString()}</td>
                 <td style="color: ${row.net_growth > 0 ? 'blue' : 'red'}">${row.net_growth > 0 ? '+' : ''}${row.net_growth.toLocaleString()}</td>
                <td>${row.total_stores.toLocaleString()}</td>
                <td>${row.avg_sales.toLocaleString()}</td>
            `;
            tableBody.appendChild(tr);
        });
    </script>
</body>
</html>
"""

def generate_report(csv_file, output_html):
    data = []
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                for key in ['total_stores', 'new_open', 'terminate', 'cancel', 'transfer', 'avg_sales', 'area_sales']:
                    row[key] = int(row[key])
            except ValueError:
                continue
            
            suspicious_numbers = range(2019, 2026)
            if row['new_open'] > 20000: continue
            if row['terminate'] + row['cancel'] > 20000: continue
            
            # ì—„ê²©í•œ í•„í„°ë§: ì—°ë„ ìˆ«ì ê·¸ëŒ€ë¡œ ë“¤ì–´ê°„ ê²½ìš° ì œì™¸ (ë‹¨, total_storesê°€ ì•„ì£¼ ë§ìœ¼ë©´ í—ˆìš©)
            # ì˜ˆ: ë½ê¼¬ê¼¬ ì „ì²´ 8ê°œì¸ë° íì  2018ê°œ -> ëª…ë°±í•œ ì˜¤ë¥˜.
            is_suspicious_terminate = (row['terminate'] + row['cancel']) in suspicious_numbers
            is_suspicious_new = row['new_open'] in suspicious_numbers
            
            if is_suspicious_terminate and row['total_stores'] < (row['terminate'] + row['cancel']) * 0.5:
                # ì „ì²´ ì í¬ì˜ 50%ë³´ë‹¤ íì ìˆ˜ê°€ ë§ì€ë° ê·¸ ìˆ˜ê°€ ì—°ë„ì™€ ê°™ë‹¤ë©´ ì œì™¸
                continue
            if is_suspicious_new and row['total_stores'] < row['new_open'] * 0.1:
                # ì „ì²´ ì í¬ì˜ 10% ë¯¸ë§Œì¸ë° ì‹ ê·œê°€ ì—°ë„ì™€ ê°™ë‹¤ë©´? (ì‹ ê·œ ë¸Œëœë“œì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì• ë§¤í•˜ì§€ë§Œ í•„í„°ë§)
                 continue

            if row['avg_sales'] > 5000000: continue

            row['close_count'] = row['terminate'] + row['cancel']
            row['net_growth'] = row['new_open'] - row['close_count']
            
            data.append(row)

    sorted_by_new = sorted(data, key=lambda x: x['new_open'], reverse=True)[:5]
    sorted_by_sales = sorted(data, key=lambda x: x['avg_sales'], reverse=True)[:5]
    sorted_by_close = sorted(data, key=lambda x: x['close_count'], reverse=True)[:5]
    sorted_by_growth = sorted(data, key=lambda x: x['net_growth'], reverse=True)[:10] 

    html_content = HTML_TEMPLATE.replace('__GROWTH_DATA__', json.dumps(sorted_by_new, ensure_ascii=False))
    html_content = html_content.replace('__SALES_DATA__', json.dumps(sorted_by_sales, ensure_ascii=False))
    html_content = html_content.replace('__CLOSE_DATA__', json.dumps(sorted_by_close, ensure_ascii=False))
    html_content = html_content.replace('__TABLE_DATA__', json.dumps(sorted_by_growth, ensure_ascii=False))

    with open(output_html, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"Report generated: {output_html}")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python generate_report.py <csv_file> <output_html>")
        sys.exit(1)
    generate_report(sys.argv[1], sys.argv[2])
